<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Exnergistick</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <header><div class="logo">EXS</div><h1>Exnergistick</h1></header>
    <main>
      <section id="auth">
        <h2>Crear cuenta</h2>
        <form id="registerForm" onsubmit="return register(event)">
          <input id="name" placeholder="Nombre completo" required/>
          <input id="email" type="email" placeholder="Correo" required/>
          <input id="phone" placeholder="Teléfono (ej: +573xxxxxxxxx)" required/>
          <input id="password" type="password" placeholder="Contraseña" required/>
          <button class="btn">Crear cuenta</button>
        </form>
        <hr/>
        <h2>Iniciar sesión</h2>
        <form id="loginForm" onsubmit="return login(event)">
          <input id="login_email" type="email" placeholder="Correo" required/>
          <input id="login_password" type="password" placeholder="Contraseña" required/>
          <button class="btn-black">Entrar</button>
        </form>
      </section>

      <section id="dashboard" style="display:none">
        <h2>Bienvenido, <span id="userName"></span></h2>
        <p>Saldo: <span id="balance">0</span> USD</p>

        <h3>Invertir con Nequi</h3>
        <div id="nequiArea">
          <img id="nequiQR" src="/api/nequi-qr" alt="QR" style="max-width:220px;border-radius:8px"/>
          <p>Número: <strong id="nequiNumber"></strong></p>
          <label>Sube comprobante (pantallazo Nequi)</label>
          <input id="proof" type="file" accept="image/*"/>
          <button class="btn" onclick="uploadProof()">He pagado - Subir comprobante</button>
          <div id="proofMsg"></div>
        </div>

        <h3>Historial</h3>
        <div id="history"></div>

        <button onclick="logout()">Cerrar sesión</button>
      </section>
    </main>
  </div>
<script>
async function register(e){
  e.preventDefault();
  const body = {
    name: document.getElementById('name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    password: document.getElementById('password').value
  };
  const res = await fetch('/api/register', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const data = await res.json();
  alert(data.ok ? 'Cuenta creada. Inicia sesión.' : (data.error||'Error'));
}
async function login(e){
  e.preventDefault();
  const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email: document.getElementById('login_email').value, password: document.getElementById('login_password').value})});
  const data = await res.json();
  if(data.token){ localStorage.setItem('ex_token', data.token); loadDashboard(); } else alert(data.error||'Error');
}
async function loadDashboard(){
  const token = localStorage.getItem('ex_token');
  if(!token) return;
  const res = await fetch('/api/me', {headers:{'Authorization':'Bearer '+token}});
  const data = await res.json();
  if(data.user){
    document.getElementById('auth').style.display='none';
    document.getElementById('dashboard').style.display='block';
    document.getElementById('userName').textContent = data.user.name;
    document.getElementById('balance').textContent = data.user.balance.toFixed(2);
    document.getElementById('nequiNumber').textContent = data.nequi.number || '';
  } else { alert('Error al cargar usuario'); }
}
async function uploadProof(){
  const file = document.getElementById('proof').files[0];
  if(!file) return alert('Selecciona una imagen');
  const token = localStorage.getItem('ex_token');
  const form = new FormData();
  form.append('proof', file);
  form.append('amount', 0);
  const res = await fetch('/api/payments/upload-proof', {method:'POST', headers:{'Authorization':'Bearer '+token}, body: form});
  const data = await res.json();
  document.getElementById('proofMsg').textContent = data.ok ? 'Comprobante enviado. Espera aprobación.' : (data.error||'Error');
  loadDashboard();
}
function logout(){ localStorage.removeItem('ex_token'); location.reload(); }
if(localStorage.getItem('ex_token')) loadDashboard();
</script>
</body>
</html>
